generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums remain the same
enum SurveyType {
  SUTM
  SKTM
  CUBICLE
  APP_TM
}

enum SurveyStatus {
  Disetujui
  Belum_Disetujui
}

enum LogType {
  Create
  Update
  Delete
}

// --- Main Project and Material Models ---

model SurveyHeader {
  id             Int          @id @default(autoincrement())
  nama_survey    String
  nama_pekerjaan String
  lokasi         String
  status_survey  SurveyStatus
  user_id        String
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt

  // One project can have multiple surveys of different types
  sutm_surveys    SutmSurvey[]
  sktm_surveys    SktmSurvey[]
  cubicle_surveys CubicleSurvey[]
  app_tm_surveys  AppTmSurvey[]
  excel_archive   ExcelArchive[]

  SurveySequance SurveySequance[]
}

model SurveySequance {
  id               Int        @id @default(autoincrement())
  survey_header_id Int
  survey_detail_id Int?
  tipe             SurveyType
  urutan           Int
  keterangan       String?
  created_at       DateTime   @default(now())

  survey_header SurveyHeader @relation(fields: [survey_header_id], references: [id])
}

model Material {
  id                Int       @id @default(autoincrement())
  id_tipe_material  Int
  nomor_material    Int
  nama_material     String
  satuan_material   String?
  berat_material    Decimal?
  harga_material    Int?
  pasang_rab        Int?
  bongkar           Int?
  jenis_material    String?
  kategori_material String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?

  // Cleaned up and consistent relations
  tipe_material        TipeMaterial         @relation(fields: [id_tipe_material], references: [id])
  sutm_konduktor       SutmSurvey[]
  sutm_tiang           SutmDetail[]
  sktm_components      SktmComponent[] // Relation to SKTM components
  cubicle_components   CubicleComponent[] // Relation to Cubicle components
  konstruksi_materials KonstruksiMaterial[]
  pole_materials       PoleMaterial[]
  loggings             Logging[]

  GroundingMaterial GroundingMaterial[]
  AccessoryMaterial AccessoryMaterial[]

  KabelMaterial KabelMaterial[]

  TerminasiMaterial TerminasiMaterial[]

  JointingMaterial JointingMaterial[]

  sktmJointsAsJointMaterial SktmJoint[] @relation("JointMaterial")

  sktmJointsAsKabelMaterial SktmJoint[] @relation("KabelMaterial")

  AppTmComponent AppTmComponent[]
}

model TipeMaterial {
  id            Int        @id @default(autoincrement())
  tipe_material String
  materials     Material[]
  loggings      Logging[]
}

// --- SUTM (Saluran Udara Tegangan Menengah) ---

model SutmSurvey {
  id                    Int       @id @default(autoincrement())
  id_survey_header      Int
  id_material_konduktor Int
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  deleted_at            DateTime?

  survey_header      SurveyHeader @relation(fields: [id_survey_header], references: [id])
  material_konduktor Material     @relation(fields: [id_material_konduktor], references: [id])
  sutm_details       SutmDetail[]
}

model SutmDetail {
  id                       Int       @id @default(autoincrement())
  id_sutm_survey           Int
  id_material_tiang        Int
  id_konstruksi            Int
  id_pole_supporter        Int?
  id_grounding_termination Int?
  penyulang                String
  panjang_jaringan         Int
  long                     String
  lat                      String
  foto                     String
  keterangan               String
  petugas_survey           String
  created_at               DateTime  @default(now())
  updated_at               DateTime  @updatedAt
  deleted_at               DateTime?

  sutm_survey           SutmSurvey            @relation(fields: [id_sutm_survey], references: [id])
  material_tiang        Material              @relation(fields: [id_material_tiang], references: [id])
  konstruksi            Konstruksi            @relation(fields: [id_konstruksi], references: [id])
  pole_supporter        PoleSupporter?        @relation(fields: [id_pole_supporter], references: [id])
  grounding_termination GroundingTermination? @relation(fields: [id_grounding_termination], references: [id])
}

// --- SKTM (Saluran Kabel Tanah Menengah) ---

model SktmSurvey {
  id               Int       @id @default(autoincrement())
  id_survey_header Int
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  deleted_at       DateTime?

  survey_header   SurveyHeader    @relation(fields: [id_survey_header], references: [id])
  sktm_details    SktmDetail[]
  sktm_components SktmComponent[]
  sktm_joints     SktmJoint[]
}

model SktmDetail {
  id               Int       @id @default(autoincrement())
  id_sktm_survey   Int
  penyulang        String
  panjang_jaringan Int
  diameter_kabel   Decimal
  long             String
  lat              String
  foto             String
  keterangan       String
  petugas_survey   String
  has_arrester     Boolean?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  deleted_at       DateTime?

  sktm_survey SktmSurvey @relation(fields: [id_sktm_survey], references: [id])
}

// Flexible table for all SKTM materials (cable, termination, arrester, etc.)
enum SktmMatType {
  CABLE
  TERMINATION
  JOINTING
  ARRESTER
  GROUNDING
}

model SktmComponent {
  id             Int         @id @default(autoincrement())
  id_sktm_survey Int
  id_material    Int
  tipe_material  SktmMatType
  kuantitas      Decimal
  keterangan     String?
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt
  deleted_at     DateTime?

  sktm_survey SktmSurvey @relation(fields: [id_sktm_survey], references: [id])
  material    Material   @relation(fields: [id_material], references: [id])
}

// Table specifically for jointing points, as they have coordinates
model SktmJoint {
  id                Int       @id @default(autoincrement())
  id_sktm_survey    Int
  id_material_kabel Int
  id_material_joint Int
  lat               String
  long              String
  urutan            Int
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?

  sktm_survey    SktmSurvey @relation(fields: [id_sktm_survey], references: [id])
  material_joint Material   @relation("JointMaterial", fields: [id_material_joint], references: [id])
  material_kabel Material   @relation("KabelMaterial", fields: [id_material_kabel], references: [id])
}

// --- CUBICLE ---

model CubicleSurvey {
  id               Int       @id @default(autoincrement())
  id_survey_header Int
  has_grounding    Boolean?
  penyulang        String
  long             String
  lat              String
  foto             String
  keterangan       String
  petugas_survey   String
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  deleted_at       DateTime?

  survey_header      SurveyHeader       @relation(fields: [id_survey_header], references: [id])
  cubicle_components CubicleComponent[] // Flexible list of all materials for this cubicle

  AppTmComponent AppTmComponent[]
}

// Flexible table for all Cubicle materials (the unit, CTs, grounding, etc.)
model CubicleComponent {
  id                Int       @id @default(autoincrement())
  id_cubicle_survey Int
  id_material       Int
  kuantitas         Decimal
  tipe_cubicle      String
  keterangan        String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?

  cubicle_survey CubicleSurvey @relation(fields: [id_cubicle_survey], references: [id])
  material       Material      @relation(fields: [id_material], references: [id])
}

// --- APP TM (Alat Pengukur Tegangan Menengah) ---

model AppTmSurvey {
  id               Int       @id @default(autoincrement())
  id_survey_header Int
  keterangan       String?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  deleted_at       DateTime?

  survey_header SurveyHeader @relation(fields: [id_survey_header], references: [id])
}

model AppTmComponent {
  id              Int       @id @default(autoincrement())
  id_apptm_survey Int
  id_material     Int
  kuantitas       Decimal
  keterangan      String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  deleted_at      DateTime?

  cubicle_survey CubicleSurvey @relation(fields: [id_apptm_survey], references: [id])
  material       Material      @relation(fields: [id_material], references: [id])
}

// --- Supporting Models (Konstruksi, Grounding, etc.) ---

model Konstruksi {
  id               Int       @id @default(autoincrement())
  nama_konstruksi  String
  nomor_konstruksi Int
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  deleted_at       DateTime?

  konstruksi_materials KonstruksiMaterial[]
  sutm_details         SutmDetail[]
}

model KonstruksiMaterial {
  id                Int      @id @default(autoincrement())
  id_material       Int
  id_konstruksi     Int
  id_tipe_pekerjaan Int?
  kuantitas         Decimal?

  material       Material       @relation(fields: [id_material], references: [id])
  konstruksi     Konstruksi     @relation(fields: [id_konstruksi], references: [id])
  tipe_pekerjaan TipePekerjaan? @relation(fields: [id_tipe_pekerjaan], references: [id])
}

model TipePekerjaan {
  id             Int    @id @default(autoincrement())
  tipe_pekerjaan String

  konstruksiMaterials KonstruksiMaterial[]
  poleMaterials       PoleMaterial[]

  GroundingMaterial GroundingMaterial[]
}

model PoleSupporter {
  id        Int    @id @default(autoincrement())
  nama_pole String

  pole_materials PoleMaterial[]
  sutm_details   SutmDetail[]
}

model PoleMaterial {
  id                Int      @id @default(autoincrement())
  id_material       Int
  id_pole_supporter Int
  kuantitas         Decimal?
  id_tipe_pekerjaan Int?

  material       Material       @relation(fields: [id_material], references: [id])
  pole_supporter PoleSupporter  @relation(fields: [id_pole_supporter], references: [id])
  tipe_pekerjaan TipePekerjaan? @relation(fields: [id_tipe_pekerjaan], references: [id])
}

model GroundingTermination {
  id             Int          @id @default(autoincrement())
  nama_grounding String
  sutm_details   SutmDetail[]

  GroundingMaterial GroundingMaterial[]
}

model GroundingMaterial {
  id                       Int        @id @default(autoincrement())
  id_material              Int
  id_grounding_termination Int
  kuantitas                Decimal?
  tipe_survey              SurveyType
  id_tipe_pekerjaan        Int?
  created_at               DateTime   @default(now())
  updated_at               DateTime   @default(now())
  deleted_at               DateTime?

  material              Material             @relation(fields: [id_material], references: [id])
  grounding_termination GroundingTermination @relation(fields: [id_grounding_termination], references: [id])
  tipe_pekerjaan        TipePekerjaan?       @relation(fields: [id_tipe_pekerjaan], references: [id])
}

model AccessoryMaterial {
  id            Int        @id @default(autoincrement())
  id_material   Int
  nama_material String
  kuantitas     Decimal?
  tipe_survey   SurveyType
  created_at    DateTime   @default(now())
  updated_at    DateTime   @default(now())
  deleted_at    DateTime?

  material Material @relation(fields: [id_material], references: [id])
}

model KabelMaterial {
  id            Int        @id @default(autoincrement())
  id_material   Int
  nama_material String
  kuantitas     Decimal?
  tipe_survey   SurveyType
  created_at    DateTime   @default(now())
  updated_at    DateTime   @default(now())
  deleted_at    DateTime?

  material Material @relation(fields: [id_material], references: [id])
}

model TerminasiMaterial {
  id            Int        @id @default(autoincrement())
  id_material   Int
  nama_material String
  kuantitas     Decimal?
  tipe_survey   SurveyType
  created_at    DateTime   @default(now())
  updated_at    DateTime   @default(now())
  deleted_at    DateTime?

  material Material @relation(fields: [id_material], references: [id])
}

model JointingMaterial {
  id            Int        @id @default(autoincrement())
  id_material   Int
  nama_material String
  kuantitas     Decimal?
  tipe_survey   SurveyType
  created_at    DateTime   @default(now())
  updated_at    DateTime   @default(now())
  deleted_at    DateTime?

  material Material @relation(fields: [id_material], references: [id])
}

model Logging {
  id                Int      @id @default(autoincrement())
  tipe_log          LogType
  id_material       Int
  id_tipe_material  Int
  nama_material     String
  satuan_material   String?
  berat_material    Decimal?
  harga_material    Int?
  pasang_rab        Int?
  bongkar           Int?
  jenis_material    String?
  kategori_material String?
  created_at        DateTime @default(now())

  material      Material     @relation(fields: [id_material], references: [id])
  tipe_material TipeMaterial @relation(fields: [id_tipe_material], references: [id])
}

model ExcelArchive {
  archive_id       Int      @id @default(autoincrement())
  file_name        String?
  file_path        String?
  survey_header_id Int?
  created_at       DateTime @default(now())

  survey_header SurveyHeader? @relation(fields: [survey_header_id], references: [id])
}
